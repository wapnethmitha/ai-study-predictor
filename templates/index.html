<!DOCTYPE html>
<html>
<head>
    <title>EduPredict - AI Study Assistant</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-left">
                <h1>üéì EduPredict</h1>
            </div>
            <button onclick="analyzeFace()">üé• Analyze Face & Recommend Study Hours</button>

            <div class="header-right">
                <div class="greeting">
                    <span id="greetingText">Good Morning</span>, <strong>{{ username }}</strong>
                </div>
                <div class="theme-toggle" onclick="toggleTheme()">
                    <span id="themeIcon">üåô</span>
                    <div class="toggle-switch" id="toggleSwitch">
                        <div class="toggle-circle"></div>
                    </div>
                </div>
                <a href="{{ url_for('logout') }}" class="logout-btn">Logout</a>
            </div>
        </div>
        
        <div class="performance">
            <h2>üìä Model Performance</h2>
            <p><strong>Test MSE:</strong> <span>{{ mse }}</span></p>
            <p><strong>Test R¬≤:</strong> <span>{{ r2 }}</span></p>
        </div>

        <!-- Predictor Section -->
        <div class="predictor">
            <h2>üîÆ Quick Predict</h2>
            <input type="text" id="hoursInput" placeholder="Enter study hours (e.g., 5 or five)">
            <button onclick="predict()">Predict Score</button>
            <div id="result"></div>
        </div>

        <!-- Chat Section -->
        <div class="chat-section">
            <h2>üí¨ AI Assistant</h2>
            <div id="chatBox" class="chat-box">
                <div class="chat-message bot">
                    <p>üëã Hi <strong>{{ username }}</strong>! I'm your AI study assistant. Ask me:<br><br>‚Ä¢ "I study 6 hours"<br>‚Ä¢ "How many hours for 80?"<br>‚Ä¢ "What score for 5 hours?"</p>
                </div>
            </div>
            <div class="chat-input-wrapper">
                <input type="text" id="chatInput" placeholder="Ask about your study hours..." onkeypress="if(event.key==='Enter') sendChat()">
                <button onclick="sendChat()">Send</button>
            </div>
        </div>
    </div>

    <script>
        // Initialize theme from localStorage
        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-theme');
                document.getElementById('toggleSwitch').classList.add('active');
                document.getElementById('themeIcon').textContent = '‚òÄÔ∏è';
            }
        }

        // Toggle theme
        function toggleTheme() {
            const isDark = document.body.classList.toggle('dark-theme');
            const toggle = document.getElementById('toggleSwitch');
            const icon = document.getElementById('themeIcon');
            
            if (isDark) {
                localStorage.setItem('theme', 'dark');
                toggle.classList.add('active');
                icon.textContent = '‚òÄÔ∏è';
            } else {
                localStorage.setItem('theme', 'light');
                toggle.classList.remove('active');
                icon.textContent = 'üåô';
            }
        }

        // Get current greeting
        function getGreeting() {
            const hour = new Date().getHours();
            if (hour < 12) return "Good Morning";
            if (hour < 18) return "Good Afternoon";
            return "Good Evening";
        }

        // Initialize on load
        window.addEventListener('DOMContentLoaded', () => {
            initTheme();
            document.getElementById('greetingText').textContent = getGreeting();
            loadChatHistory();
        });

        // Load chat history
        function loadChatHistory() {
            fetch('/history')
                .then(res => res.json())
                .then(chats => {
                    if (chats && chats.length > 0) {
                        chats.reverse().forEach(c => {
                            addChat('user', c.message);
                            addChat('bot', c.response);
                        });
                    }
                });
        }

        function addChat(sender, text) {
            const div = document.createElement('div');
            div.className = 'chat-message ' + sender;
            div.innerHTML = `<p>${formatMessage(text)}</p>`;
            document.getElementById('chatBox').appendChild(div);
        }

        const wordToNumber = {
            'zero': 0, 'one': 1, 'two': 2, 'three': 3, 'four': 4, 'five': 5,
            'six': 6, 'seven': 7, 'eight': 8, 'nine': 9, 'ten': 10,
            'half': 0.5, 'and half': 0.5
        };

        function addReaction(type) {
            fetch('/react', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({type: type})
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showReactionFeedback(type);
                }
            })
            .catch(() => {});
        }

        function showReactionFeedback(type) {
            const emoji = type === 'thumbs_up' ? 'üëç' : 'üëé';
            const message = type === 'thumbs_up' ? 'Thanks!' : 'We will improve!';
            
            const feedback = document.createElement('div');
            feedback.className = 'reaction-feedback';
            feedback.textContent = `${emoji} ${message}`;
            document.body.appendChild(feedback);
            
            setTimeout(() => feedback.remove(), 2000);
        }

        function formatMessage(text) {
            text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            text = text.replace(/\n/g, '<br>');
            return text;
        }

        function predict() {
            let hoursInput = document.getElementById('hoursInput').value.trim().toLowerCase();
            
            if (!hoursInput) {
                alert('Please enter study hours');
                return;
            }
            
            let hours = parseFloat(hoursInput);
            
            if (isNaN(hours)) {
                hours = wordToNumber[hoursInput];
                if (!hours) {
                    for (let word in wordToNumber) {
                        if (hoursInput.includes(word)) {
                            hours = wordToNumber[word];
                            break;
                        }
                    }
                }
            }
            
            if (isNaN(hours) || hours === undefined) {
                alert('Please enter a valid number');
                return;
            }
            
            fetch('/predict', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({hours: hours})
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                    return;
                }
                let tipsHTML = '<div class="tips-section"><strong>üí° Study Tips:</strong><ul>';
                data.tips.forEach(tip => {
                    tipsHTML += `<li>${formatMessage(tip)}</li>`;
                });
                tipsHTML += '</ul></div>';
                
                document.getElementById('result').innerHTML = 
                    `<p class="success">If you study <strong>${hours}</strong> hours ‚Üí Score: <strong>${data.prediction}</strong></p>
                    ${tipsHTML}
                    <div class="reaction-buttons">
                        <button class="reaction-btn" onclick="addReaction('thumbs_up')">üëç Helpful</button>
                        <button class="reaction-btn" onclick="addReaction('thumbs_down')">üëé Not helpful</button>
                    </div>`;
            });
        }

        function sendChat() {
            let message = document.getElementById('chatInput').value.trim();
            
            if (!message) return;
            
            const chatBox = document.getElementById('chatBox');
            const userDiv = document.createElement('div');
            userDiv.className = 'chat-message user';
            userDiv.innerHTML = `<p>${message}</p>`;
            chatBox.appendChild(userDiv);
            
            document.getElementById('chatInput').value = '';
            chatBox.scrollTop = chatBox.scrollHeight;
            
            fetch('/chat', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({message: message})
            })
            .then(response => response.json())
            .then(data => {
                const botDiv = document.createElement('div');
                botDiv.className = 'chat-message bot';
                botDiv.innerHTML = `<p>${formatMessage(data.response)}
                    <div class="reaction-buttons">
                        <button class="reaction-btn" onclick="addReaction('thumbs_up')">üëç</button>
                        <button class="reaction-btn" onclick="addReaction('thumbs_down')">üëé</button>
                    </div></p>`;
                chatBox.appendChild(botDiv);
                chatBox.scrollTop = chatBox.scrollHeight;
            });
        }
    </script>
</body>
</html>