<!DOCTYPE html>
<html>
<head>
    <title>EduPredict - AI Study Assistant</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>


    
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-left">
                <h1>ğŸ“ EduPredict</h1>
            </div>

            <div class="header-right">
                <div class="greeting">
                    <span id="greetingText">Good Morning</span>, <strong>{{ username }}</strong>
                </div>
                <div class="theme-toggle" onclick="toggleTheme()">
                    <span id="themeIcon">ğŸŒ™</span>
                    <div class="toggle-switch" id="toggleSwitch">
                        <div class="toggle-circle"></div>
                    </div>
                </div>
                <a href="{{ url_for('logout') }}" class="logout-btn">Logout</a>
            </div>
        </div>
        

        <!-- SECTION 1: TOP LAYOUT -->
        <div class="top-section">
            
            <!-- LEFT: HERO IMAGE -->
            <div class="hero-left">
            <img src="{{ url_for('static', filename='heroimg.png') }}" alt="Study Image">
            </div>

            <!-- RIGHT: FACE ANALYZER -->
            <div class="face-right">
                <h2>ğŸ“¸ Face Analysis</h2>
                <button id="faceButton" class="highlight-btn">Analyze My Focus/Emotion</button>
                <div id="faceResult"></div>
            </div>

        </div>

        <div class="chat-bottom">
        <!-- Chat Section -->
        <div class="chat-section">
            <h2>ğŸ’¬ AI Assistant</h2>
            <div id="chatBox" class="chat-box">
                <div class="chat-message bot">
                    <p>ğŸ‘‹ Hi <strong>{{ username }}</strong>! I'm your AI study assistant. Ask me:<br><br>â€¢ "I study 6 hours"<br>â€¢ "How many hours for 80?"<br>â€¢ "What score for 5 hours?"</p>
                </div>
            </div>
            <div class="chat-input-wrapper">
                <input type="text" id="chatInput" placeholder="Ask about your study hours..." onkeypress="if(event.key==='Enter') sendChat()">
                <button onclick="sendChat()">Send</button>
            </div>
        </div>
        </div>
    </div>

    <script>
        // Initialize theme from localStorage
        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-theme');
                document.getElementById('toggleSwitch').classList.add('active');
                document.getElementById('themeIcon').textContent = 'â˜€ï¸';
            }
        }

        // Toggle theme
        function toggleTheme() {
            const isDark = document.body.classList.toggle('dark-theme');
            const toggle = document.getElementById('toggleSwitch');
            const icon = document.getElementById('themeIcon');
            
            if (isDark) {
                localStorage.setItem('theme', 'dark');
                toggle.classList.add('active');
                icon.textContent = 'â˜€ï¸';
            } else {
                localStorage.setItem('theme', 'light');
                toggle.classList.remove('active');
                icon.textContent = 'ğŸŒ™';
            }
        }

        // Get current greeting
        function getGreeting() {
            const hour = new Date().getHours();
            if (hour < 12) return "Good Morning";
            if (hour < 18) return "Good Afternoon";
            return "Good Evening";
        }

        // Initialize on load
        window.addEventListener('DOMContentLoaded', () => {
            initTheme();
            document.getElementById('greetingText').textContent = getGreeting();
            loadChatHistory();
        });

        // Load chat history
        function loadChatHistory() {
            fetch('/history')
                .then(res => res.json())
                .then(chats => {
                    if (chats && chats.length > 0) {
                        chats.reverse().forEach(c => {
                            addChat('user', c.message);
                            addChat('bot', c.response);
                        });
                    }
                });
        }

        function addChat(sender, text) {
            const div = document.createElement('div');
            div.className = 'chat-message ' + sender;
            div.innerHTML = `<p>${formatMessage(text)}</p>`;
            document.getElementById('chatBox').appendChild(div);
        }

        const wordToNumber = {
            'zero': 0, 'one': 1, 'two': 2, 'three': 3, 'four': 4, 'five': 5,
            'six': 6, 'seven': 7, 'eight': 8, 'nine': 9, 'ten': 10,
            'half': 0.5, 'and half': 0.5
        };

        function addReaction(type) {
            fetch('/react', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({type: type})
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showReactionFeedback(type);
                }
            })
            .catch(() => {});
        }

        function showReactionFeedback(type) {
            const emoji = type === 'thumbs_up' ? 'ğŸ‘' : 'ğŸ‘';
            const message = type === 'thumbs_up' ? 'Thanks!' : 'We will improve!';
            
            const feedback = document.createElement('div');
            feedback.className = 'reaction-feedback';
            feedback.textContent = `${emoji} ${message}`;
            document.body.appendChild(feedback);
            
            setTimeout(() => feedback.remove(), 2000);
        }

        function formatMessage(text) {
            text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            text = text.replace(/\n/g, '<br>');
            return text;
        }

        function predict() {
    let hoursInput = document.getElementById('hoursInput').value.trim().toLowerCase();
    
    if (!hoursInput) {
        alert('Please enter study hours');
        return;
    }

    let hours = parseFloat(hoursInput);
    
    if (isNaN(hours)) {
        hours = wordToNumber[hoursInput];
        if (!hours) {
            for (let word in wordToNumber) {
                if (hoursInput.includes(word)) {
                    hours = wordToNumber[word];
                    break;
                }
            }
        }
    }
    
    if (isNaN(hours) || hours === undefined) {
        alert('Please enter a valid number');
        return;
    }
    
    fetch('/predict', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({hours: hours})
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert(data.error);
            return;
        }

        let tipsHTML = '<div class="tips-section"><strong>ğŸ’¡ Study Tips:</strong><ul>';
        data.tips.forEach(tip => {
            tipsHTML += `<li>${formatMessage(tip)}</li>`;
        });
        tipsHTML += '</ul></div>';
        
        // Update result here AFTER fetch
        document.getElementById('result').innerHTML = 
            `<div class="prediction-card">
                If you study <strong>${hours}</strong> hours â†’ Score: <strong>${data.prediction}</strong>
            </div>
            ${tipsHTML}
            <div class="reaction-buttons">
                <button class="reaction-btn" onclick="addReaction('thumbs_up')">ğŸ‘ Helpful</button>
                <button class="reaction-btn" onclick="addReaction('thumbs_down')">ğŸ‘ Not helpful</button>
            </div>`;
    });
}


        function sendChat() {
            let message = document.getElementById('chatInput').value.trim();
            
            if (!message) return;
            
            const chatBox = document.getElementById('chatBox');
            const userDiv = document.createElement('div');
            userDiv.className = 'chat-message user';
            userDiv.innerHTML = `<p>${message}</p>`;
            chatBox.appendChild(userDiv);
            
            document.getElementById('chatInput').value = '';
            chatBox.scrollTop = chatBox.scrollHeight;
            
            fetch('/chat', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({message: message})
            })
            .then(response => response.json())
            .then(data => {
                const botDiv = document.createElement('div');
                botDiv.className = 'chat-message bot';
                botDiv.innerHTML = `<p>${formatMessage(data.response)}
                    <div class="reaction-buttons">
                        <button class="reaction-btn" onclick="addReaction('thumbs_up')">ğŸ‘</button>
                        <button class="reaction-btn" onclick="addReaction('thumbs_down')">ğŸ‘</button>
                    </div></p>`;
                chatBox.appendChild(botDiv);
                chatBox.scrollTop = chatBox.scrollHeight;
            });
        }

        // Face Analysis
document.getElementById('faceButton').addEventListener('click', async () => {
    const faceResultDiv = document.getElementById('faceResult');
    faceResultDiv.innerHTML = 'Opening webcam... ğŸ¥';

    try {
        // Ask for webcam permission
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        const video = document.createElement('video');
        video.srcObject = stream;
        video.autoplay = true;
        video.width = 320;
        video.height = 240;
        faceResultDiv.innerHTML = '';
        faceResultDiv.appendChild(video);

        // Wait 3 seconds to capture
        setTimeout(async () => {
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            // Convert image to base64
            const imgData = canvas.toDataURL('image/jpeg');

            // Stop webcam
            stream.getTracks().forEach(track => track.stop());

// Show analyzing message
faceResultDiv.innerHTML = `<div class="face-card" style="background: var(--card-bg); color: var(--text-primary);">Analyzing... â³</div>`;

// Give the browser a moment to repaint
setTimeout(async () => {
    // Send image to backend
    const response = await fetch('/analyze_face', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ image: imgData })
    });
    const data = await response.json();

    // Show results
    faceResultDiv.innerHTML = `
        <div class="face-card">
            <h3>ğŸ¯ Predicted Focus</h3>
            <p><strong>${data.focus}</strong></p>
            <h3>â± Recommended Study Hours</h3>
            <p><strong>${data.recommended_hours} hours</strong></p>
            <div class="reaction-buttons">
                <button class="reaction-btn" onclick="addReaction('thumbs_up')">ğŸ‘ Helpful</button>
                <button class="reaction-btn" onclick="addReaction('thumbs_down')">ğŸ‘ Not helpful</button>
            </div>
        </div>
    `;
}, 50); // 50ms is enough for a repaint




        }, 3000);

    } catch (err) {
        console.error(err);
        faceResultDiv.innerHTML = 'Error accessing webcam âŒ';
    }
});
// QUICK PREDICT POPUP CONTROL
document.addEventListener("DOMContentLoaded", function () {
    const btn = document.getElementById("quickPredictBtn");
    const modal = document.getElementById("predictModal");

    if (btn) {
        btn.addEventListener("click", () => {
            modal.classList.remove("hidden");
        });
    }
});

function closePredictModal() {
    document.getElementById("predictModal").classList.add("hidden");
}


    </script>
  
    <!-- Floating Quick Predict Button -->
<button id="quickPredictBtn" class="floating-btn">ğŸ”® Quick Predict</button>
<!-- QUICK PREDICT POPUP MODAL -->
<div id="predictModal" class="modal hidden">
    <div class="modal-content">
        <span class="close-btn" onclick="closePredictModal()">&times;</span>
        
        <h2>ğŸ”® Quick Predict</h2>

        <label>Enter Study Hours:</label>
        <input type="number" id="hoursInput" placeholder="e.g., 4">

        <button class="predict-btn" onclick="predict()">Predict Score</button>

        <div id="result"></div>
    </div>
</div>
<!-- ===================== -->
<!-- FOOTER: MODEL PERFORMANCE -->
<!-- ===================== -->
<footer class="footer">
    <div class="performance">
        <h2>ğŸ“Š Model Performance</h2>
        <p><strong>Test MSE:</strong> <span>{{ mse }}</span></p>
        <p><strong>Test RÂ²:</strong> <span>{{ r2 }}</span></p>
    </div>
</footer>


</body>
</html>