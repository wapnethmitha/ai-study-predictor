<!DOCTYPE html>
<html>
<head>
    <title>EduPredict - AI Study Assistant</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>


    
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-left">
                <h1>EduPredict</h1>
            </div>

            <div class="header-right">
                <div class="greeting">
                    <span id="greetingText">Good Morning</span>, <strong>{{ username }}</strong>
                </div>
                <div class="theme-toggle" onclick="toggleTheme()">
                    <span id="themeIcon">üåô</span>
                    <div class="toggle-switch" id="toggleSwitch">
                        <div class="toggle-circle"></div>
                    </div>
                </div>
                <a href="{{ url_for('logout') }}" class="logout-btn">Logout</a>
            </div>
        </div>
        

        <!-- SECTION 1: TOP LAYOUT -->
        <div class="top-section">
            
            <!-- LEFT: HERO IMAGE -->
            <div class="hero-left">
                <img src="{{ url_for('static', filename='heroimg.png') }}" alt="Study Image">
            </div>

            <!-- MIDDLE: VERTICAL LINE -->
            <div class="divider"></div>
            <!-- RIGHT: FACE ANALYZER -->
            <div class="face-right">
                <h2>üëã Hello, I‚Äôm Neo!</h2>
                <div class="mood-card" id="moodCard">
                    <p>Make sure your face is clearly visible in the camera. I‚Äôll tell you your current mood and suggest how many hours you should study!</p>
                    
                    <!-- Initial Button -->
                    <button id="showMoodBtn" class="highlight-btn">Show My Mood</button>
                    
                    <!-- Webcam & Result -->
                    <div id="analyzeSection" class="hidden">
                        <div class="webcam-frame">
                            <video id="webcamVideo" autoplay></video>
                            <div class="overlay-text">üîé Neo is analyzing your mood...</div>
                        </div>
                        
                        <div class="mood-result hidden">
                            <h3>üéØ Predicted Focus</h3>
                            <p id="focusText"><strong>Loading...</strong></p>
                            <h3>‚è± Recommended Study Hours</h3>
                            <p id="hoursText"><strong>0 hours</strong></p>
                            
                            <button id="checkAgainBtn" class="highlight-btn">Done</button>
                        </div>
                    </div>
                </div>

            </div>

            </div>

            </div>

        </div>


        <div class="chat-bottom">
        <!-- Chat Section -->
        <div class="chat-section">
    <h2>üí¨ AI Assistant</h2>
    <div id="chatBox" class="chat-box">
        <div class="chat-message bot">
            <p>üí¨ You want to chat more with me? Feel free to ask! I'm still under training, so ask in a way I can easily understand hehe.<br><br>
            ‚Ä¢ "I study 6 hours"<br>
            ‚Ä¢ "How many hours for 80?"<br>
            ‚Ä¢ "What score for 5 hours?"</p>
        </div>
    </div>

    <!-- Clear Chat History Button -->
    <button id="clearChatBtn" class="highlight-btn" style="margin-top: 10px;">üßπ Clear Chat History</button>

    <div class="chat-input-wrapper">
        <input type="text" id="chatInput" placeholder="Ask about your study hours..." onkeypress="if(event.key==='Enter') sendChat()">
        <button onclick="sendChat()">Send</button>
    </div>
</div>

        </div>
    </div>

    <script>
        // Initialize theme from localStorage
        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-theme');
                document.getElementById('toggleSwitch').classList.add('active');
                document.getElementById('themeIcon').textContent = '‚òÄÔ∏è';
            }
        }

        // Toggle theme
        function toggleTheme() {
            const isDark = document.body.classList.toggle('dark-theme');
            const toggle = document.getElementById('toggleSwitch');
            const icon = document.getElementById('themeIcon');
            
            if (isDark) {
                localStorage.setItem('theme', 'dark');
                toggle.classList.add('active');
                icon.textContent = '‚òÄÔ∏è';
            } else {
                localStorage.setItem('theme', 'light');
                toggle.classList.remove('active');
                icon.textContent = 'üåô';
            }
        }

        // Get current greeting
        function getGreeting() {
            const hour = new Date().getHours();
            if (hour < 12) return "Good Morning";
            if (hour < 18) return "Good Afternoon";
            return "Good Evening";
        }

        // Initialize on load
        window.addEventListener('DOMContentLoaded', () => {
            initTheme();
            document.getElementById('greetingText').textContent = getGreeting();
            loadChatHistory();
        });

        // Load chat history
        function loadChatHistory() {
            fetch('/history')
                .then(res => res.json())
                .then(chats => {
                    if (chats && chats.length > 0) {
                        chats.reverse().forEach(c => {
                            addChat('user', c.message);
                            addChat('bot', c.response);
                        });
                    }
                });
        }

        function addChat(sender, text) {
            const div = document.createElement('div');
            div.className = 'chat-message ' + sender;
            div.innerHTML = `<p>${formatMessage(text)}</p>`;
            document.getElementById('chatBox').appendChild(div);
        }

        const wordToNumber = {
            'zero': 0, 'one': 1, 'two': 2, 'three': 3, 'four': 4, 'five': 5,
            'six': 6, 'seven': 7, 'eight': 8, 'nine': 9, 'ten': 10,
            'half': 0.5, 'and half': 0.5
        };

        function addReaction(type) {
            fetch('/react', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({type: type})
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showReactionFeedback(type);
                }
            })
            .catch(() => {});
        }

        function showReactionFeedback(type) {
            const emoji = type === 'thumbs_up' ? 'üëç' : 'üëé';
            const message = type === 'thumbs_up' ? 'Thanks!' : 'We will improve!';
            
            const feedback = document.createElement('div');
            feedback.className = 'reaction-feedback';
            feedback.textContent = `${emoji} ${message}`;
            document.body.appendChild(feedback);
            
            setTimeout(() => feedback.remove(), 2000);
        }

        function formatMessage(text) {
            text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            text = text.replace(/\n/g, '<br>');
            return text;
        }

        function predict() {
    let hoursInput = document.getElementById('hoursInput').value.trim().toLowerCase();
    
    if (!hoursInput) {
        alert('Please enter study hours');
        return;
    }

    let hours = parseFloat(hoursInput);
    
    if (isNaN(hours)) {
        hours = wordToNumber[hoursInput];
        if (!hours) {
            for (let word in wordToNumber) {
                if (hoursInput.includes(word)) {
                    hours = wordToNumber[word];
                    break;
                }
            }
        }
    }
    
    if (isNaN(hours) || hours === undefined) {
        alert('Please enter a valid number');
        return;
    }
    
    fetch('/predict', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({hours: hours})
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert(data.error);
            return;
        }

        let tipsHTML = '<div class="tips-section"><strong>üí° Study Tips:</strong><ul>';
        data.tips.forEach(tip => {
            tipsHTML += `<li>${formatMessage(tip)}</li>`;
        });
        tipsHTML += '</ul></div>';
        
        // Update result here AFTER fetch
        document.getElementById('result').innerHTML = 
            `<div class="prediction-card">
                If you study <strong>${hours}</strong> hours ‚Üí Score: <strong>${data.prediction}</strong>
            </div>
            ${tipsHTML}
            <div class="reaction-buttons">
                <button class="reaction-btn" onclick="addReaction('thumbs_up')">üëç Helpful</button>
                <button class="reaction-btn" onclick="addReaction('thumbs_down')">üëé Not helpful</button>
            </div>`;
    });
}


        function sendChat() {
            let message = document.getElementById('chatInput').value.trim();
            
            if (!message) return;
            
            const chatBox = document.getElementById('chatBox');
            const userDiv = document.createElement('div');
            userDiv.className = 'chat-message user';
            userDiv.innerHTML = `<p>${message}</p>`;
            chatBox.appendChild(userDiv);
            
            document.getElementById('chatInput').value = '';
            chatBox.scrollTop = chatBox.scrollHeight;
            
            fetch('/chat', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({message: message})
            })
            .then(response => response.json())
            .then(data => {
                const botDiv = document.createElement('div');
                botDiv.className = 'chat-message bot';
                botDiv.innerHTML = `<p>${formatMessage(data.response)}
                    <div class="reaction-buttons">
                        <button class="reaction-btn" onclick="addReaction('thumbs_up')">üëç</button>
                        <button class="reaction-btn" onclick="addReaction('thumbs_down')">üëé</button>
                    </div></p>`;
                chatBox.appendChild(botDiv);
                chatBox.scrollTop = chatBox.scrollHeight;
            });
        }

        // Face Analysis
    const showMoodBtn = document.getElementById('showMoodBtn');
    const analyzeSection = document.getElementById('analyzeSection');
    const moodResult = analyzeSection.querySelector('.mood-result');
    const checkAgainBtn = document.getElementById('checkAgainBtn');
    const webcamVideo = document.getElementById('webcamVideo');

    showMoodBtn.addEventListener('click', async () => {
        showMoodBtn.classList.add('hidden');
        analyzeSection.classList.remove('hidden');
        moodResult.classList.add('hidden');

        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            webcamVideo.srcObject = stream;

            setTimeout(async () => {
                const canvas = document.createElement('canvas');
                canvas.width = webcamVideo.videoWidth;
                canvas.height = webcamVideo.videoHeight;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(webcamVideo, 0, 0, canvas.width, canvas.height);
                const imgData = canvas.toDataURL('image/jpeg');

                stream.getTracks().forEach(track => track.stop());

                analyzeSection.querySelector('.overlay-text').textContent = 'üîé Neo is analyzing your mood...';

                setTimeout(async () => {
                    const response = await fetch('/analyze_face', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ image: imgData })
                    });
                    const data = await response.json();

                    moodResult.classList.remove('hidden');
                    document.getElementById('focusText').innerHTML = `<strong>${data.focus}</strong>`;
                    document.getElementById('hoursText').innerHTML = `<strong>${data.recommended_hours} hours</strong>`;
                }, 500);

            }, 3000);
        } catch (err) {
            console.error(err);
            analyzeSection.querySelector('.overlay-text').textContent = '‚ùå Error accessing webcam';
        }
    });

    checkAgainBtn.addEventListener('click', () => {
        moodResult.classList.add('hidden');
        showMoodBtn.classList.remove('hidden');
        analyzeSection.classList.add('hidden');
    });


checkAgainBtn.addEventListener('click', () => {
    moodResult.classList.add('hidden');
    showMoodBtn.classList.remove('hidden');
    analyzeSection.classList.add('hidden');
});


        checkAgainBtn.addEventListener('click', () => {
            moodResult.classList.add('hidden');
            showMoodBtn.classList.remove('hidden');
            analyzeSection.classList.add('hidden');
        });


// QUICK PREDICT POPUP CONTROL
document.addEventListener("DOMContentLoaded", function () {
    const btn = document.getElementById("quickPredictBtn");
    const modal = document.getElementById("predictModal");

    if (btn) {
        btn.addEventListener("click", () => {
            modal.classList.remove("hidden");
        });
    }
});

function closePredictModal() {
    document.getElementById("predictModal").classList.add("hidden");
}
// Clear Chat History
document.getElementById("clearChatBtn").addEventListener("click", () => {
    if (!confirm("Are you sure you want to clear your chat history?")) return;

    fetch("/clear_history", { method: "POST" })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                document.getElementById("chatBox").innerHTML = "";
                alert("Chat history cleared successfully!");
            } else {
                alert("Failed to clear history.");
            }
        });
});





    </script>
  
    <!-- Floating Quick Predict Button -->
<button id="quickPredictBtn" class="floating-btn">Quick Predict!</button>
<!-- QUICK PREDICT POPUP MODAL -->
<div id="predictModal" class="modal hidden">
    <div class="modal-content">
        <span class="close-btn" onclick="closePredictModal()">&times;</span>
        
        <h2>üîÆ Quick Predict</h2>

        <label>Enter Study Hours:</label>
        <input type="number" id="hoursInput" placeholder="e.g., 4">

        <button class="predict-btn" onclick="predict()">Predict Score</button>

        <div id="result"></div>
    </div>
</div>
<!-- ===================== -->
<!-- FOOTER: MODEL PERFORMANCE -->
<!-- ===================== -->
<footer class="footer">
    <div class="performance">
        <h2>üìä Model Performance</h2>
        <p><strong>Test MSE:</strong> <span>{{ mse }}</span></p>
        <p><strong>Test R¬≤:</strong> <span>{{ r2 }}</span></p>
    </div>
</footer>


</body>
</html>